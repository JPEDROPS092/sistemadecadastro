{% extends 'base.html' %}

{% block title %}Terminal de Vendas - PDV{% endblock %}

{% block content %}
<style>
    .modal-custom {
        display: none; position: fixed; z-index: 2000;
        left: 0; top: 0; width: 100%; height: 100%;
        background: rgba(16, 22, 26, 0.7); backdrop-filter: blur(4px);
        align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-open { display: flex !important; opacity: 1; }
    .modal-content {
        width: 100%; max-width: 450px; background: white; padding: 25px; border-radius: 6px;
        transform: translateY(-20px); transition: transform 0.3s ease;
    }
    .modal-open .modal-content { transform: translateY(0); }
    .bp4-dark .modal-content { background: #30404d; color: white; border: 1px solid rgba(255,255,255,0.1); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
</style>

<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; border-bottom: 1px solid rgba(16, 22, 26, 0.15); padding-bottom: 15px;">
    <div>
        <h1 class="bp4-heading" style="margin: 0;">Frente de Caixa</h1>
        <p class="bp4-text-muted" style="margin: 5px 0 0 0;">Operador: <strong>{{ current_user.username }}</strong></p>
    </div>
    <div class="bp4-button-group">
        <a href="{{ url_for('caixa.historico') }}" class="bp4-button bp4-icon-history">Ver Histórico</a>
        {% if caixa %}
            <button class="bp4-button bp4-intent-danger bp4-icon-lock" onclick="toggleModal('fecharCaixaModal', true)">Encerrar Turno</button>
        {% endif %}
    </div>
</div>

{% if not caixa %}
    <div style="display: flex; justify-content: center; padding: 40px 0;">
        <div class="bp4-card bp4-elevation-2" style="width: 400px; border-top: 5px solid #d9822b;">
            <div style="text-align: center; margin-bottom: 20px;">
                <span class="bp4-icon bp4-icon-info-sign bp4-intent-warning" style="font-size: 40px;"></span>
                <h3 class="bp4-heading">Caixa Fechado</h3>
                <p class="bp4-text-muted">Informe o saldo inicial para começar.</p>
            </div>
            <form method="POST" action="{{ url_for('caixa.abrir') }}">
                <div class="bp4-form-group">
                    <label class="bp4-label">Saldo Inicial (Dinheiro)</label>
                    <div class="bp4-input-group bp4-large">
                        <span class="bp4-icon bp4-icon-dollar"></span>
                        <input type="number" name="saldo_inicial" class="bp4-input" step="0.01" value="0.00" required>
                    </div>
                </div>
                <button type="submit" class="bp4-button bp4-intent-success bp4-fill bp4-large">Abrir Caixa</button>
            </form>
        </div>
    </div>
{% else %}
    <div class="dashboard-grid">
        <div class="bp4-card bp4-elevation-1" style="border-left: 4px solid #2d72d2;">
            <small class="bp4-text-muted">ABERTURA</small>
            <h3 class="bp4-heading">R$ {{ "%.2f"|format(caixa.saldo_inicial) }}</h3>
        </div>
        <div class="bp4-card bp4-elevation-1" style="border-left: 4px solid #0f9960;">
            <small class="bp4-text-muted">ENTRADAS (+)</small>
            <h3 class="bp4-heading" style="color: #0f9960;">R$ {{ "%.2f"|format(caixa.total_entradas) }}</h3>
        </div>
        <div class="bp4-card bp4-elevation-1" style="border-left: 4px solid #db3737;">
            <small class="bp4-text-muted">SAÍDAS (-)</small>
            <h3 class="bp4-heading" style="color: #db3737;">R$ {{ "%.2f"|format(caixa.total_saidas) }}</h3>
        </div>
        <div class="bp4-card bp4-elevation-2" style="background: #394b59; color: white;">
            <small style="opacity: 0.8;">SALDO ATUAL</small>
            <h3 class="bp4-heading" style="color: #3dcc91;">R$ {{ "%.2f"|format(caixa.saldo_calculado) }}</h3>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 25px;">
        <div class="bp4-card bp4-elevation-1">
            <h4 class="bp4-heading" style="margin-bottom: 20px;"><span class="bp4-icon bp4-icon-shopping-cart"></span> 1. Lançar Item</h4>
            
            <div id="alerta-caixa"></div>

            <form hx-post="{{ url_for('caixa.adicionar_item') }}" hx-target="#lista-venda" hx-swap="beforeend" hx-on::after-request="this.reset()">
                <div class="bp4-form-group">
                    <label class="bp4-label">Produto</label>
                    <div class="bp4-select bp4-fill">
                        <select name="produto_id" required>
                            <option value="">Selecione...</option>
                            {% for p in produtos %}
                                <option value="{{ p.id }}">{{ p.nome }} (R$ {{ "%.2f"|format(p.valor_venda) }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="bp4-form-group">
                    <label class="bp4-label">Quantidade</label>
                    <input type="number" name="quantidade" class="bp4-input bp4-fill bp4-large" value="1" min="1">
                </div>
                <button type="submit" class="bp4-button bp4-intent-primary bp4-fill bp4-large">Adicionar ao Carrinho</button>
            </form>
        </div>

        <div class="bp4-card bp4-elevation-1" style="display: flex; flex-direction: column; min-height: 450px; padding-bottom: 0;">
            <h4 class="bp4-heading">2. Resumo da Venda</h4>
            
            <form action="{{ url_for('caixa.finalizar') }}" method="POST" style="display: flex; flex-direction: column; flex-grow: 1;">
                <div style="flex-grow: 1; overflow-y: auto; margin-top: 15px; border: 1px solid rgba(16, 22, 26, 0.15); border-radius: 3px;">
                    <table class="bp4-html-table bp4-html-table-striped bp4-fill" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th style="text-align: center;">Qtd</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="lista-venda"></tbody>
                    </table>
                </div>

                <div style="background: rgba(16, 22, 26, 0.05); margin: 0 -20px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="bp4-form-group" style="margin: 0;">
                            <label class="bp4-label bp4-inline">Pagamento:</label>
                            <div class="bp4-select">
                                <select name="forma_pagamento">
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao">Cartão</option>
                                    <option value="pix">PIX</option>
                                </select>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <small class="bp4-text-muted">TOTAL DA VENDA</small>
                            <h1 class="bp4-heading" style="margin: 0; color: #106ba3;" id="venda-total">R$ 0,00</h1>
                        </div>
                    </div>
                    <div class="bp4-button-group bp4-fill" style="margin-top: 20px;">
                        <button type="button" class="bp4-button bp4-icon-trash" onclick="window.location.reload()">Limpar</button>
                        <button type="submit" class="bp4-button bp4-intent-success bp4-large bp4-icon-tick-circle">Finalizar Venda</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endif %}

<div id="fecharCaixaModal" class="modal-custom" onclick="if(event.target == this) toggleModal('fecharCaixaModal', false)">
    <div class="bp4-card bp4-elevation-4 modal-content" style="border-top: 5px solid #db3737;">
        <h3 class="bp4-heading">Encerrar Turno</h3>
        <div class="bp4-callout bp4-intent-danger" style="margin: 15px 0;">
            Saldo final esperado: <strong>R$ {{ "%.2f"|format(caixa.saldo_calculado if caixa else 0) }}</strong>
        </div>
        <form method="POST" action="{{ url_for('caixa.fechar') }}">
            <div class="bp4-form-group">
                <label class="bp4-label">Observações</label>
                <textarea name="observacao" class="bp4-input bp4-fill" rows="3" placeholder="Ex: Tudo OK..."></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="bp4-button bp4-minimal" onclick="toggleModal('fecharCaixaModal', false)">Cancelar</button>
                <button type="submit" class="bp4-button bp4-intent-danger">Confirmar Fechamento</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. Gerenciamento de Modais
    function toggleModal(id, show) {
        const modal = document.getElementById(id);
        if (modal) {
            show ? modal.classList.add('modal-open') : modal.classList.remove('modal-open');
        }
    }

    // 2. Cálculo dinâmico do total da venda
    function atualizarTotalVenda() {
        let total = 0;
        document.querySelectorAll('.valor-total-item').forEach(el => {
            total += parseFloat(el.dataset.valor || 0);
        });
        const totalDisplay = document.getElementById('venda-total');
        if (totalDisplay) {
            totalDisplay.innerText = 'R$ ' + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
    }

    // 3. Exibição de erros de estoque ou validação
    function mostrarErroCaixa(mensagem) {
        const alerta = document.getElementById('alerta-caixa');
        if (alerta) {
            alerta.innerHTML = `
                <div class="bp4-callout bp4-intent-danger bp4-icon-error" style="margin-bottom: 15px; animation: fadeIn 0.3s ease;">
                    <h4 class="bp4-heading">Atenção</h4>
                    ${mensagem}
                </div>
            `;
            setTimeout(() => { alerta.innerHTML = ''; }, 5000);
        }
    }

    // 4. Listeners para HTMX (Adição de itens)
    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        if (evt.detail.target.id === "lista-venda") {
            atualizarTotalVenda();
        }
    });

    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.target.id === "lista-venda") {
            mostrarErroCaixa(evt.detail.xhr.responseText);
        }
    });

    // 5. Atalhos de teclado
    document.addEventListener('keydown', (e) => { 
        if (e.key === 'Escape') toggleModal('fecharCaixaModal', false); 
    });
</script>
{% endblock %}